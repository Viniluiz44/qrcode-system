document.getElementById('scan').addEventListener('click', () => {
    const qrCodeScanner = new Html5Qrcode("reader");

    console.log("Inicializando leitor QR Code...");
    Html5Qrcode.getCameras().then(cameras => {
        if (cameras && cameras.length) {
            // Tenta encontrar a câmera traseira com "back" no rótulo
            let cameraId = cameras.find(camera => camera.label.toLowerCase().includes('back'))?.id;
            
            // Se não encontrar, usa a primeira câmera
            if (!cameraId && cameras[1]) {
                cameraId = cameras[1].id; // Posição 1 é tipicamente a traseira, 0 é a frontal
            } else if (!cameraId) {
                cameraId = cameras[0].id; // Se não encontrar, usa a primeira disponível
            }

            qrCodeScanner.start(
                { deviceId: { exact: cameraId } },
                {
                    fps: 10,
                    qrbox: 250
                },
                (decodedText) => {
                    console.log("QR Code lido com sucesso:", decodedText);
                    document.getElementById("qr_code").value = decodedText;
                    qrCodeScanner.stop();
                    document.getElementById("reader").style.display = "none";
                },
                (errorMessage) => {
                    console.log("Erro durante a leitura:", errorMessage);
                }
            ).catch((err) => {
                console.error("Erro ao acessar a câmera:", err);
                alert("Não foi possível acessar a câmera. Verifique as permissões no navegador.");
            });

            document.getElementById("reader").style.display = "block";
        } else {
            console.error("Nenhuma câmera encontrada.");
            alert("Nenhuma câmera foi encontrada no dispositivo.");
        }
    }).catch(err => {
        console.error("Erro ao obter a lista de câmeras:", err);
        alert("Erro ao obter a lista de câmeras. Verifique as permissões no navegador.");
    });
});
